___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "CLIENT",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Data Client",
  "brand": {
    "id": "brand_dummy",
    "displayName": "Onetagger",
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAYAAAB5fY51AAAACXBIWXMAAAsSAAALEgHS3X78AAAXVklEQVR4nO3dzXHbyNYG4HdUd8GdfCOwJgJjIhAnAmsiML1HlTkRGI7gaqq4NxXBpSIYKIIBI7hkBJ+5w07fog9sWuIPADZw+nS/TxXLNbaHPJLFl6d/0Pjl+fkZRER1nt0AmALI5HED4O2J/2UHoAKwkV/LyaKqhqzxFwYWUbrqPMsAzADc4XQ4tbUDsAKwmiyqlYfn+wkDiygxdZ69gQuoAn5C6pgtgCWA+8mi+ubjCRlYRImQoJrL43rEl94BuIeH4GJgESWgzrM7uNAYsqM6ZwegmCyq+75PwMAiiph0VUsA75VL2fcEYDZZVJuu/+OV/1qIKAR1nk3hVvBCCisAuAVQ1Xk26/o/MrCIIiRh8DfGnavq4hrA1zrPOg0POSQkikydZ0sAH7Tr6OBhsqhmbf4iOyyiiBgMKwD4IHWfxcAiioQMr6yFVaNVaDGwiCIgc1aftOu40Idzc1qcwyIyTi6v+Ue7Do8+ThbV8tAfMLCIDJN9VhV0N4T6tgOQHdqnxSEhkW1LxBVWgNvysDz0BwwsIqNkY2hom0J9ua3zbP7yNxlYRHYttQsYWCFD3u/+pVUJEfUnq4JjDQWfDvze7Qivew13skTR/AYn3YkMqvNsg+ECqzmEbzlZVOWJGprD/2YY7hKgHYCb5lgaBhaRMdJdfR3gqXufWyXzTQWGCa4vk0VVAJzDIrJoNsBzruG2EhR9DtmTM65uADz6Lgx7Xy87LCJD5EYR//P8tA8A5r6OMR7oesY/JotqxQ6LyJY7z8/3MFlUM19hBQBy8sKDr+cTdwCHhETW+AysNdwqnHcSWj6HhwwsIoN8bifw2lkden64iXwfrus8yxhYREbIznZfHoa+6amEYeHxKacMLCI7ph6fq/D4XEfJ6qGvLosdFpEhN56e57HPHWsusPT0PDcMLCI7bjw9j/dbyJ+x9PQ87LCIDHlz/q+0Unp6nlY8zpVdM7CI7Hjn40lGHg42Dl1A3RkDiygtXoJDCwOLiMxgYBGlxdc8mAoGFlFavMyD9eAlKBlYRHasfTyJnPgwNi9BycAissPXdX9TT8/TisdLirYMLCI7fO1nmnl6nrFfb8PAIrJj4+l5bscaFspdb3wdiVPxrjkRk5sE7E92Tns+1QZ7b5ZTNyagQfk8XaHAOJ3WHP7Oea94RLJR8smVwV1ftv94g/FWgnb48SYq9379NvTRJamq88znG/b3IT98pIur4C+wfmVgGSCTlhl+BNQY94TzYQ3XmVXNQ+mykGjUebaCv7s9/3QLLZ/kA7WEvw/P7WRR3XBIGBgZxk3xI6C09s348E4e399gdZ41XVkpj2rgUy9jU8JfYF0DKOs8mw7wb3APvz+7K4B3zVG3F1DNY6gbUoZsjR8BVjLAjpPO5f88P+0agJfQkvru4f+uOb9NFhXnsMa2t2oylV9TDKhznuA+UUvOhb3meVjY2AG4u2ROSz58l/A/KthOFtUNwA5rFDL5eCcPK/NPodjChdeKq5OOzGn+PdDTPwAousw1ys93Af9dVePjZFEtAQbWYPZCagbb81Ah2cGF133qnVedZxsAbwd8iSe4bqk8FF7y8z2F+xn33e3t+2lhgIHlWZ1nMwz/j0g/Oq/7FFce6zy7A/DfEV9yjR+XBo05SvgyWVRF8x8MLA9k7D4H56S0PAFYNsOGVNR5ViLuKYYtgGx/MYCBdQHppubgkC8UO7hhTBJdl3xQ/qNdx4D+mCyqn26YwcDqSFb55vB7yQH59wgXXKV2IUOq8+wewCftOgbwOFlUr65BZGC1NMJKCA1jDRdcS+1ChlLnWYW4uvyjO/AZWGcwqKKxhVuuX2oX4psMDUvE0/EfvcaRgXUEgypaUQaXwqrhUD6e+rdhYL3AoEpGdMEli0Bfteu4wMNkUc1O/QUGlpDJ9AJxTmDScU9wwVVqF+KD4dA6G1YAAwsAUOfZHC6sYpkDoO4eAcxj2A5hMLT+miyqeZu/mHRgyTVZSwx7iQPZ8gVuVdH0iREyp7VE+B/CJ+esXkoysGSe6h68fIYO28J1W6uzfzNgA56e4MMW7nSITteEJhdYHP5RB1EMEwPcXPoIYNani00msOTT5h5xX3tF/u3gJuXvtQu5RCA//1u4oCr7PkESgVXnWQHgs3YdZNoT3Jtto13IJWRu6x7jztt620ISdWDJXNUS7KrIjyi6LeD7gtMcw87jej9FI9rAkqXde3CuivzrPQcTGtl/OIM7jM9HeDXHW6+G6EajCyz5B1iCK4A0rIvPQA/R3i3lbuTXY/e5bA7028ijHON7EVVgycTiCtxXReP56URMGlY0gWVwdy/F4wmu2zI/RAyd+cAa8D5oRF3s4O7tl/TNMYZ2pV3AJWQVsATDivRdA/hHOn0aiNnAkvmq2E5aJPu+ys5yGoDJISHnq8iAaLY+hMRcYMm1gP/RroOohTXcvBZDyxNTgVXn2RKcr/JpBzes3ncDbgvxiZPxHpkILK4EerGG26NWAdicewPJ9zyTx1QevGqgH4aWJ8EHlrxxSnByvY8nuF3/Kx/DEt7h+iJR7owfW9CBxbDq7QHuIt3NUC8gCx8FOHzsqtMJm/SzYAOLYdXL4EH1EoOrF4ZWT0EGFsOqszXcErrKHIn8e83BM8e6YGj1EFxgMaw6C+biW1583hlDq6OgAoth1UmQk7g83qczhlYHwQQWw6oT1SFgG9wz18nvoX3whCqkawlXYFi10eyeDjasAEDu4vtRuw4jVjKcpjOCCCz5NOa56+eZutRDhjpftOsw4BpAydA6T31IyKFDazsAmcW7tvDfuLUt3L+xiQ8kDaqBxVMXOvkt9GHgKXWe8Sigdkx10WNTGxLK/dEYVu18sRxWYgrXJdJp7+BWWekAlcCSsfpS47UNegpln9UlpGOYaddhxHseAnjY6IEl2xdW4MWzbc20C/BlsqhWcAfb0XmfeNzyaxodFndCt/fF4iT7GXPtAgz5ypXDn40aWNLmcvtCOzu4M8CiIgH8oF2HIaWMSggjBpZMsn8a6/UicB/xSlGhXYAh13CjEsJIgSW341qO8VoRWWoXMBR2WZ3d1nlWaBcRgrE6LE6yd/MY4dzVS0vtAoz5XOfZVLsIbYMHlsxbccNgN0vtAoYmF/tuteswZpX6fNaggSWfCJy36kiW/1OQytfpyzUS+DA7ZbDA2ttvRd2ktE+p1C7AoPdyb84kDdlhLcF5qz5K7QLGklAn6VshC1nJGSSwZAsDT5zsx/o1g12ttQswKNmhoffA2jsil/pJLbBS+3p9uU1xaDhEh3UPDgV7i3iz6DEb7QIMS25o6DWwZFWQB7X196RdgIKNdgGGXSPCy7dO8d1hLT0/H8Vvo12Ace9lzjgJ3gJLLh3gKQxE47tPZUOpl8CScXRyE4BEgXiLRN5/vjosTrQT6fqcwgT8xYElE+3cc0WkL/oJeB8dVvTfpBElMQ/xAk/U9Od97Cc6XBRYcuY0T2LwJ8XvZYohPaRCu4AhXdphFT6KoB9SWe3Zc6NdQGRuY755Re/Akm8KtzH4l9oQKbWvdwyFdgFD6RVY0gVw7moYU+0CRpbiMHhob2Ptsvp2WHNwG8NQptoFjCX2CWJlhXYBQ+gcWNJdJbFJTUlKt0GbahcQsSi7rD4d1h3YXQ0qoWvDUvk6tRTaBfjWJ7AK30XQK9G/kWVXNuevhhVdl9UpsLgyOJq7BLY3zLQLSERU0zddO6xiiCLolWvE/4aO6o0UsHcxLW60Diz5otldjSfaN7R06pwHHU80P0tdOqxovmgjopt/2FNoF5CY97Gc5NAqsOSL5YkM44vuYDYe9KgmioajbYc1G7IIOuoaEXUjPOhR1Uy7AB/aBhZ/yPR8imjSdAnOXWm5jmGK4WxgcYI0CEvrQ0MZCqa0iz9EM+0CLtWmw4p+E6MBb2H4FvbyofdZuw7CrfXJ95OBxcn2oLyr82ypXURXElZfteug70xP75zrsNhdheVDnWdmhocMqyCZfk+fC6zZGEVQJx8AlKG39jJnxbAKz9s6z8wemng0sHhxatDeAahCXPWp8+ymzrMSnLMKmdlh4b9O/Jnp1jEB1wC+SmgVk0VVahazd04aD3cMn9n39qkh4WysIugitwD+rvOs1NqvJcO/DVxXxbAK37XVvX2/PD8/v/pNGQ7+b/RqyIcHuI5rM/QLNd0deKmNRX9NFpW5oeGxwJoD+M/45ZBHDwCWvoeKMvSbwQ39GFR2bSeL6ka7iK6OBVYJ7kqOxRrukpjlZFF96/skMoSYwa1SUhx+myyqSruILl7NYcknKMMqHu/guuVLl7ILMKxiM9UuoKtDk+7TsYsgIhXmVgsPBZa5L4KIerm1ctVEgx0WUdqm2gV08VNgyXYGrvwQpWOqXUAXLzusqUYRRKRmql1AFwwsorS9szSPxcAiIjOnN3wPLElZzl8RpWeqXUBb+x2WmZQlIq+m2gW0tR9YU60iiEiVmWaFHRYRXYd+gm2DgUVEgJH3/xXACXciMhRYMFIsEQ3GRAYwsIgIAG60C2ijCawbzSKISJ2JO2SxwyIiAICF+xWywyKiRvDXFDaBxRVCIppqF3DOlZUNY0REV+BwkIicqXYB5zCwiMgMBhYRNcysEhIRXWsXcM4VDKQqERHgAiv4vRdENI46z6baNZzCISERmcFJdyIy4wrc5U5EPwQ9RcQhIRHtC3oRjoFFRGYwsIjIDAYWEZnBwCIiMxhYRGQGA4uIzGBgEZEZDCwiMoOBRURmMLCIyAwGFhGZwcAiIjMYWERkBgOLiPaV2gWccgXgSbsIIqI22GERkRkMLCLa9027gFOuAGy0iyCiMEwWVaVdwykMLCIyg0NCImqstQs45wqBL2MS0WiCnr8C2GER0Q8b7QLOuQIQ9CQbEY1mo13AOVeTRRV8G0hEo9hoF3BOMyTkbnci2mgXcE4TWOyyiCj46aEmsIIvlIiGZWF6iIFFRICRaaEmsDaaRRCRuo12AW1cAeFfP0REgzORAfsbR4Pflk9EgzEXWCYKJiL/Jouq1K6hDQYWEZkZXe0HVqlVBBGpMtOsfA8sTrwTJcvMe//laQ0m9mIQkVeldgFtvQysUqMIIlKzszS6YmARpa3ULqCLnwLLytImEXlTahfQxaETRzmPRZSOUruALg4FVjl2EUSkwtT8FXA4sFajV0FEGsy9118FliTuTqEWGtalZx0Ff1YSdVZqF9DVsbvmmEteOugJwEcA/7609Z8sqjsAvwF48FEYBcHc+/yX5+fnV79Z59kdgP+OXw558gSgGGrVt86zGwAzAJ+HeH4axdNkUU21i+jqYGABQJ1nh/+AQjZoUL0kwVUA+DDG65FXf04W1b12EV2dupHq42hV0KWeAPw+WVTTMffSTRbVZrKoZgB+hRsqcu7TDnPDQeB0hzUD8HXUaqirLVxHtdQuBADqPHsDYA4OFUO3niyqTLuIPk51WCvwEzNkDwCyUMIKcHddmSyqAm5y3swZSwlaahfQ19EOCwDqPFuC8xMh+hhSUB3Dn59g/TpZVBvtIvo41WEBRse5kTMRVgAg81vcBhGWR6thBZwJrMmiWsHNk1AYzIRVg6EVHNNNyLkOCzD+BUbkT2th1ZDQ4kX1+nZWf4YabQLL3F6NCD1a3DPzwh24iKPNfPNxNrBkvMtPRz1buF3lpk0W1Te40CI91j/0WnVYgOFl0AjM5c1unmxq5YZkHWtrR8kc0iqwZNzLdn58T7LwEZO5dgGJMt9dAe07LCCSL9iY6N7cMsXAVcNxmZ9sbzCwwvUYQwt/RKFdQGKiee+2DiyZR+En43ii+SF7SboszmWNJ5qfpS4dFsBPxrFsE7iD0VK7gEQ8xLJoA3QMLG5xGE00n4jHyGICF3KGV2gX4FPXDguI7BsQqNhWBo9J5evU8mD5usFDOgeWDFXYZQ1nG9sP2QmldgGRK7QL8K1PhwVE+I0ISKldwIhK7QIiFl13BfQMLHZZgyq1CxiLvKE4jzWMQruAIfTtsIBIvyEBiHXv1TGpfb1jiLK7Ai4ILOmyuC/Ls4g3ix6T2tc7hkK7gKFc0mEBEX9jlKQ4PIpmj1AgvsTaXQEXBpZ8Y/7yUwohzW4jxa95KDtEvofv0g4LcF1Wip0B+cEOy58ipl3th1wcWPINKi4vhYgusI3gVNqzfHRYkG8U70NHpGemXcAYvASWiO7sJiIjHhO4WB6Ax8DiNgciFTsk0l0BfjsswHVZnIDv7412AQqm2gUYF/1E+z6vgSXfuJnP50zMO+0CyJSnFCba9/nusJpzjniaZE91nt1o1zCyqXYBhiU3b+w9sMQMHBr2lWkXMLIb7QKM+pLgZVzDBBaHhheZahcwFukm32rXYdDTZFEV2kVoGKrD4tCwv6l2ASOaahdgUFKrgi8NFlhiBnerdWrvXULzWLx1fXfzmC9uPmfQwOLQsLfo38h1nr0B8F67DmMeY7khal9Dd1jNhtIvQ79OZFJY/Yk+lD3bgh/+wwcWAMgEIY9Ubu9tnWdT7SIGVmgXYMxdShtEjxklsMQduNWhi0K7gKFIGHN1sL2PKW5hOGS0wJJPh+lYrxeB24i7rKR2Z1/oIfV5q31jdljNeeUfx3xN4wrtAnyr82wGXoLU1hppzGe29svz8/PoL1rn2RLAh9Ff2KY/Y7leTFYGNwCulUuxYAfghvNWPxu1w2pMFtUMnIRvq4hoX9YSDKs2dgCmDKvXVAJL3IGnlLZxDWClXcSlZCjIfVftzDnJfphaYMmnB1cO23knw2iT6jzLwIn2tv7kJPtxKnNY++SHuQSHCm18tPbDzHmrTh5kuoSO0BwSAvi+cjjTrsOIrzK0MkHCqgTDqg2GVQvqHVZD3ohfteswIvhOay+suIXhvPVkUaV2Dlov6h1WQ96A3KPVztc6zwrtIo6RYX4FhlUba3BDdWvBdFgNdlqdPAKYhbT8Lf9+9+AwsI01uH2hk+ACC2BodbSFC61SswgZAt6DG4LbYlj1EGRgAQytHh7g9u+M/gZgV9UZw6qnYAMLYGj1sIMLjvsx3gxycXYB4Hbo14oIw+oCQQcWwNDqaQe3O/7e945pGfrdwQUVj4jphmF1oeADC2BoXWgNF15l33kuuZZxChdUvLymnyfwEL6LmQgsAKjz7A68eNaHJ7gtB9/2fn0pA/BGfs3ATupS3BTqiZnAAngZD5nEsPIomI2jbch8TAae8kA2fGRY+WUqsABA7sk2Bc/TonDtAPwR+uVTFpkaEr7Ek0spQFu4yXWeZzUAcx3WPmm3ef0hheIJQMawGo7pDqvByXgKwF+TRcUbRgzMdIfVkE+0G3Bei8bXzFcxrEYQRYe1T45d+axdByVhDTdftdEuJBXRBRbw/Rq3JbjhkYbDIaCCKAML+H7N2xK8lIT8CuI4n1RFG1gNXtJDHgV3YGJqog8sgN0WXWwHF1Tm7w9pXRKB1WC3RT2oHYxIryUVWACP8qXWOFcVoOQCqyEriffgnV3oZzu4gw8L7ULotWQDq1Hn2Rzu9EwOE+kRbvi30S6EDks+sIDvw8QCwCflUkjHGi6oSu1C6DQG1h45CrgA57dSsQVQ8BgYOxhYB/BuMNHbwXVUS+1CqBsG1gkMruiMehs08o+B1YIE1xzceGrVFu6DZ8Wgso2B1QHnuMxZw3VTS+1CyA8GVg+yqjiXB7dDhOcRLqhK7ULILwbWheQmrzNwnktbMz+15D6qeDGwPJHh4hzu7sg8h2s8j3AhxQuTE8DAGoBcZN08OGT0bw13EfuK3VRaGFgDkrmuJri4wngZhhQxsMbEzquzJwArMKRIMLCUyK3J7uDuYs0Je2cLd7u2FYCSe6boJQZWIGRzavNIJcCagCrhAmqjWQyFj4EVKOnApgAyeVg/t2sLoJJHCaBiB0VdMbAMkRC7wY8Qe4PwurEtgA1cMDW/MpzICwZWJGRICbiuDHDBdrP3Vy4NtiaIAOAbXBBBfm8DYMMhHQ3t/wE9ujNMn3ArJgAAAABJRU5ErkJggg\u003d\u003d"
  },
  "description": "Used to map your Request Data to useful Events. Get started with Onetagger Webhooks.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "CHECKBOX",
    "name": "exposeFPIDCookie",
    "checkboxText": "Expose FPID Cookie",
    "simpleValueType": true,
    "help": "If enabled, the server only accessible FPID cookie, generated by UA/GA4 client, will be duplicated to FPIDP cookie, which will be accessible from the client JS. Highly recommend using this option only in case it is necessary."
  },
  {
    "type": "CHECKBOX",
    "name": "generateClientId",
    "checkboxText": "Always generate client_id parameter",
    "simpleValueType": true,
    "help": "If enabled, even if the `client_id` parameter will not be determined from the request, it will still be generated. The `client_id` parameter is required by UA/GA4 tags.",
    "defaultValue": true
  },
  {
    "type": "CHECKBOX",
    "name": "prolongCookies",
    "checkboxText": "Automatically prolong Data Tag cookies",
    "simpleValueType": true,
    "help": "If enabled, cookies generated by Data tag will be reseated from the server with an expiration time of two years. Useful if you use Data tag store functionality.",
    "defaultValue": true
  },
  {
    "type": "CHECKBOX",
    "name": "acceptMultipleEvents",
    "checkboxText": "Accept Multiple Events",
    "simpleValueType": true,
    "help": "When the Accept Multiple Events is set to true, the Data Client will parse an array of objects, in the request body, as separate events.\nExample:\n\u003cbr /\u003e\n[\n  {\"event\":\"page_view\"},\n  {\"event\":\"view_item\"}\n]",
    "defaultValue": false
  },
  {
    "type": "GROUP",
    "name": "responseSettings",
    "displayName": "Response Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SELECT",
        "name": "responseStatusCode",
        "displayName": "Response Status Code",
        "selectItems": [
          {
            "value": 200,
            "displayValue": "200"
          },
          {
            "value": 201,
            "displayValue": "201"
          },
          {
            "value": 301,
            "displayValue": "301"
          },
          {
            "value": 302,
            "displayValue": "302"
          },
          {
            "value": 403,
            "displayValue": "403"
          },
          {
            "value": 404,
            "displayValue": "404"
          }
        ],
        "simpleValueType": true,
        "defaultValue": 200
      },
      {
        "type": "GROUP",
        "name": "regularResponseSettings",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "SELECT",
            "name": "responseBody",
            "displayName": "Response Body",
            "macrosInSelect": false,
            "selectItems": [
              {
                "value": "timestamp",
                "displayValue": "JSON Object with timestamp (recommended)"
              },
              {
                "value": "eventData",
                "displayValue": "JSON Object with Event Data"
              },
              {
                "value": "empty",
                "displayValue": "Empty"
              }
            ],
            "simpleValueType": true,
            "defaultValue": "timestamp"
          },
          {
            "type": "CHECKBOX",
            "name": "responseBodyGet",
            "checkboxText": "Send Response Body for GET request",
            "simpleValueType": true,
            "help": "By default, for the GET request type, the answer is image pixel.  \u003ca target\u003d\"_blank\" href\u003d\"https://developers.google.com/tag-manager/serverside/api#setpixelresponse\"\u003eMore Info\u003c/a\u003e."
          }
        ],
        "enablingConditions": [
          {
            "paramName": "responseStatusCode",
            "paramValue": 200,
            "type": "EQUALS"
          },
          {
            "paramName": "responseStatusCode",
            "paramValue": 201,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "redirectResponseSettings",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "TEXT",
            "name": "redirectTo",
            "displayName": "Redirect To",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              },
              {
                "type": "REGEX",
                "args": [
                  "^https?:\\/\\/.*"
                ]
              }
            ]
          },
          {
            "type": "CHECKBOX",
            "name": "lookupForRedirectToParam",
            "checkboxText": "Try to find redirect destination in query params",
            "simpleValueType": true,
            "help": "Override destination URL with query param from request url"
          },
          {
            "type": "TEXT",
            "name": "redirectToQueryParamName",
            "displayName": "Query Param Name",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "lookupForRedirectToParam",
                "paramValue": true,
                "type": "EQUALS"
              }
            ],
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "responseStatusCode",
            "paramValue": 301,
            "type": "EQUALS"
          },
          {
            "paramName": "responseStatusCode",
            "paramValue": 302,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "clientErrorResponseSettings",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "TEXT",
            "name": "clientErrorResponseMessage",
            "displayName": "Client Error Response Message",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "responseStatusCode",
            "paramValue": 403,
            "type": "EQUALS"
          },
          {
            "paramName": "responseStatusCode",
            "paramValue": 404,
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "pathSettings",
    "displayName": "Webhook Path Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "path",
        "displayName": "Type additional paths that will be claimed by this client",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "For example: /callback",
            "name": "path",
            "type": "TEXT",
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "newRowButtonText": "Add path",
        "help": "By default path \u003cb\u003e/data\u003c/b\u003e will be claimed. But you can add more paths that will be claimed by this client."
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const returnResponse = require('returnResponse');
const runContainer = require('runContainer');
const setResponseHeader = require('setResponseHeader');
const setResponseStatus = require('setResponseStatus');
const setResponseBody = require('setResponseBody');
const JSON = require('JSON');
const fromBase64 = require('fromBase64');
const getTimestampMillis = require('getTimestampMillis');
const getCookieValues = require('getCookieValues');
const getRequestBody = require('getRequestBody');
const getRequestMethod = require('getRequestMethod');
const getRequestHeader = require('getRequestHeader');
const getRequestPath = require('getRequestPath');
const getRequestQueryParameters = require('getRequestQueryParameters');
const makeInteger = require('makeInteger');
const getRemoteAddress = require('getRemoteAddress');
const setCookie = require('setCookie');
const setPixelResponse = require('setPixelResponse');
const generateRandom = require('generateRandom');
const computeEffectiveTldPlusOne = require('computeEffectiveTldPlusOne');
const getRequestQueryParameter = require('getRequestQueryParameter');
const getType = require('getType');
const Promise = require('Promise');
const decodeUriComponent = require('decodeUriComponent');
const createRegex = require('createRegex');
const makeString = require('makeString');

const requestMethod = getRequestMethod();
const path = getRequestPath();
let isClientUsed = false;
let isEventModelsWrappedInArray = false;

if (path === '/data') {
  runClient();
}

if (data.path && !isClientUsed) {
  for (let key in data.path) {
    if (!isClientUsed && data.path[key].path === path) {
      runClient();
    }
  }
}

function runClient() {
  isClientUsed = true;
  require('claimRequest')();

  if (requestMethod === 'OPTIONS') {
    setResponseHeaders(200);
    returnResponse();
    return;
  }
  const baseEventModel = getBaseEventModelWithQueryParameters();
  let eventModels = getEventModels(baseEventModel);
  const clientId = getClientId(eventModels);
  eventModels = eventModels.map((eventModel) => {
    eventModel = addRequiredParametersToEventModel(eventModel);
    eventModel = addCommonParametersToEventModel(eventModel);
    eventModel = addClientIdToEventModel(eventModel, clientId);
    return eventModel;
  });

  storeClientId(eventModels[0]);
  exposeFPIDCookie(eventModels[0]);
  prolongDataTagCookies(eventModels[0]);
  const responseStatusCode = makeInteger(data.responseStatusCode);
  setResponseHeaders(responseStatusCode);

  Promise.all(
    eventModels.map((eventModel) => {
      return Promise.create((resolve) => {
        runContainer(eventModel, resolve);
      });
    })
  ).then(() => {
    switch (responseStatusCode) {
      case 200:
      case 201:
        if (requestMethod === 'POST' || data.responseBodyGet) {
          prepareResponseBody(eventModels);
        } else {
          setPixelResponse();
        }
        break;
      case 301:
      case 302:
        setRedirectLocation();
        break;
      case 403:
      case 404:
        setClientErrorResponseMessage();
        break;
    }

    returnResponse();
  });
}

function addCommonParametersToEventModel(eventModel) {
  if (!eventModel.ip_override) {
    if (eventModel.ip) eventModel.ip_override = eventModel.ip;
    else if (eventModel.ipOverride)
      eventModel.ip_override = eventModel.ipOverride;
    else eventModel.ip_override = getRemoteAddress();
  }

  if (!eventModel.user_agent) {
    if (eventModel.userAgent) eventModel.user_agent = eventModel.userAgent;
    else if (getRequestHeader('User-Agent'))
      eventModel.user_agent = getRequestHeader('User-Agent');
  }

  if (!eventModel.language) {
    const acceptLanguageHeader = getRequestHeader('Accept-Language');

    if (acceptLanguageHeader) {
      eventModel.language = acceptLanguageHeader
        .split(';')[0]
        .substring(0, 2)
        .toLowerCase();
    }
  }

  if (!eventModel.page_hostname) {
    if (eventModel.pageHostname)
      eventModel.page_hostname = eventModel.pageHostname;
    else if (eventModel.hostname)
      eventModel.page_hostname = eventModel.hostname;
  }

  if (!eventModel.page_location) {
    if (eventModel.pageLocation)
      eventModel.page_location = eventModel.pageLocation;
    else if (eventModel.url) eventModel.page_location = eventModel.url;
    else if (eventModel.href) eventModel.page_location = eventModel.href;
  }

  if (!eventModel.page_referrer) {
    if (eventModel.pageReferrer)
      eventModel.page_referrer = eventModel.pageReferrer;
    else if (eventModel.referrer)
      eventModel.page_referrer = eventModel.referrer;
    else if (eventModel.urlref) eventModel.page_referrer = eventModel.urlref;
  }

  if (!eventModel.value && eventModel.e_v) eventModel.value = eventModel.e_v;

  if (getType(eventModel.items) === 'array' && eventModel.items.length) {
    const firstItem = eventModel.items[0];
    if (!eventModel.currency && firstItem.currency)
      eventModel.currency = firstItem.currency;
    if (eventModel.items.length === 1) {
      if (!eventModel.item_id && firstItem.item_id)
        eventModel.item_id = firstItem.item_id;
      if (!eventModel.item_name && firstItem.item_name)
        eventModel.item_name = firstItem.item_name;
      if (!eventModel.item_brand && firstItem.item_brand)
        eventModel.item_brand = firstItem.item_brand;
      if (!eventModel.item_quantity && firstItem.quantity)
        eventModel.item_quantity = firstItem.quantity;
      if (!eventModel.item_category && firstItem.item_category)
        eventModel.item_category = firstItem.item_category;
      if (!eventModel.item_price && firstItem.price)
        eventModel.item_price = firstItem.price;
    }
    if (!eventModel.value) {
      const valueFromItems = eventModel.items.reduce((acc, item) => {
        if (!item.price) return acc;
        const quantity = item.quantity ? item.quantity : 1;
        return acc + quantity * item.price;
      }, 0);
      if (valueFromItems) eventModel.value = valueFromItems;
    }
  }

  const ecommerceAction = getEcommerceAction(eventModel);

  if (ecommerceAction) {
    if (!eventModel['x-ga-mp1-pa']) eventModel['x-ga-mp1-pa'] = ecommerceAction;

    if (
      ecommerceAction === 'purchase' &&
      eventModel.ecommerce.purchase.actionField
    ) {
      if (!eventModel['x-ga-mp1-tr'])
        eventModel['x-ga-mp1-tr'] =
          eventModel.ecommerce.purchase.actionField.revenue;
      if (!eventModel.revenue)
        eventModel.revenue = eventModel.ecommerce.purchase.actionField.revenue;
      if (!eventModel.affiliation)
        eventModel.affiliation =
          eventModel.ecommerce.purchase.actionField.affiliation;
      if (!eventModel.tax)
        eventModel.tax = eventModel.ecommerce.purchase.actionField.tax;
      if (!eventModel.shipping)
        eventModel.shipping =
          eventModel.ecommerce.purchase.actionField.shipping;
      if (!eventModel.coupon)
        eventModel.coupon = eventModel.ecommerce.purchase.actionField.coupon;
      if (!eventModel.transaction_id)
        eventModel.transaction_id =
          eventModel.ecommerce.purchase.actionField.id;
    }
  }

  if (!eventModel.page_encoding && eventModel.pageEncoding)
    eventModel.page_encoding = eventModel.pageEncoding;
  if (!eventModel.page_path && eventModel.pagePath)
    eventModel.page_path = eventModel.pagePath;
  if (!eventModel.page_title && eventModel.pageTitle)
    eventModel.page_title = eventModel.pageTitle;
  if (!eventModel.screen_resolution && eventModel.screenResolution)
    eventModel.screen_resolution = eventModel.screenResolution;
  if (!eventModel.viewport_size && eventModel.viewportSize)
    eventModel.viewport_size = eventModel.viewportSize;
  if (!eventModel.user_id && eventModel.userId)
    eventModel.user_id = eventModel.userId;

  if (!eventModel.user_data) {
    let userData = {};
    let userAddressData = {};

    if (!userData.email_address) {
      if (eventModel.userEmail) userData.email_address = eventModel.userEmail;
      else if (eventModel.email_address)
        userData.email_address = eventModel.email_address;
      else if (eventModel.email) userData.email_address = eventModel.email;
      else if (eventModel.mail) userData.email_address = eventModel.mail;
    }

    if (!userData.phone_number) {
      if (eventModel.userPhoneNumber)
        userData.phone_number = eventModel.userPhoneNumber;
      else if (eventModel.phone_number)
        userData.phone_number = eventModel.phone_number;
      else if (eventModel.phoneNumber)
        userData.phone_number = eventModel.phoneNumber;
      else if (eventModel.phone) userData.phone_number = eventModel.phone;
    }

    if (!userAddressData.street && eventModel.street)
      userAddressData.street = eventModel.street;
    if (!userAddressData.city && eventModel.city)
      userAddressData.city = eventModel.city;
    if (!userAddressData.region && eventModel.region)
      userAddressData.region = eventModel.region;
    if (!userAddressData.country && eventModel.country)
      userAddressData.country = eventModel.country;

    if (!userAddressData.first_name) {
      if (eventModel.userFirstName)
        userAddressData.first_name = eventModel.userFirstName;
      else if (eventModel.first_name)
        userAddressData.first_name = eventModel.first_name;
      else if (eventModel.firstName)
        userAddressData.first_name = eventModel.firstName;
      else if (eventModel.name) userAddressData.first_name = eventModel.name;
    }

    if (!userAddressData.last_name) {
      if (eventModel.userLastName)
        userAddressData.last_name = eventModel.userLastName;
      else if (eventModel.last_name)
        userAddressData.last_name = eventModel.last_name;
      else if (eventModel.lastName)
        userAddressData.last_name = eventModel.lastName;
      else if (eventModel.surname)
        userAddressData.last_name = eventModel.surname;
      else if (eventModel.family_name)
        userAddressData.last_name = eventModel.family_name;
      else if (eventModel.familyName)
        userAddressData.last_name = eventModel.familyName;
    }

    if (!userAddressData.region) {
      if (eventModel.region) userAddressData.region = eventModel.region;
      else if (eventModel.state) userAddressData.region = eventModel.state;
    }

    if (!userAddressData.postal_code) {
      if (eventModel.postal_code)
        userAddressData.postal_code = eventModel.postal_code;
      else if (eventModel.postalCode)
        userAddressData.postal_code = eventModel.postalCode;
      else if (eventModel.zip) userAddressData.postal_code = eventModel.zip;
    }

    if (getObjectLength(userAddressData) !== 0) {
      userData.address = userAddressData;
    }

    if (!eventModel.user_data && getObjectLength(userData) !== 0) {
      eventModel.user_data = userData;
    }
  }

  return eventModel;
}

function getBaseEventModelWithQueryParameters() {
  const requestQueryParameters = getRequestQueryParameters();
  const eventModel = {};

  if (requestQueryParameters) {
    for (let queryParameterKey in requestQueryParameters) {
      if (
        (queryParameterKey === 'dtcd' || queryParameterKey === 'dtdc') &&
        requestMethod === 'GET'
      ) {
        let dt =
          queryParameterKey === 'dtcd'
            ? JSON.parse(requestQueryParameters[queryParameterKey])
            : JSON.parse(fromBase64(requestQueryParameters[queryParameterKey]));

        for (let dtKey in dt) {
          eventModel[dtKey] = dt[dtKey];
        }
      } else {
        eventModel[queryParameterKey] =
          requestQueryParameters[queryParameterKey];
      }
    }
  }

  return eventModel;
}

function addClientIdToEventModel(eventModel, clientId) {
  eventModel.client_id = clientId;
  return eventModel;
}

function prolongDataTagCookies(eventModel) {
  if (data.prolongCookies) {
    let onetaggerData = getCookieValues('onetagger');

    if (onetaggerData.length) {
      setCookie('onetagger', onetaggerData[0], {
        domain: 'auto',
        path: '/',
        samesite: getCookieType(eventModel),
        secure: true,
        'max-age': 63072000, // 2 years
        httpOnly: false,
      });
    }
  }
}

function addRequiredParametersToEventModel(eventModel) {
  if (!eventModel.event_name) {
    let eventName = 'Data';

    if (eventModel.eventName) eventName = eventModel.eventName;
    else if (eventModel.event) eventName = eventModel.event;
    else if (eventModel.e_n) eventName = eventModel.e_n;

    eventModel.event_name = eventName;
  }

  return eventModel;
}

function exposeFPIDCookie(eventModel) {
  if (data.exposeFPIDCookie) {
    let fpid = getCookieValues('FPID');

    if (fpid.length) {
      setCookie('FPIDP', fpid[0], {
        domain: 'auto',
        path: '/',
        samesite: getCookieType(eventModel),
        secure: true,
        'max-age': 63072000, // 2 years
        httpOnly: false,
      });
    }
  }
}

function storeClientId(eventModel) {
  if (data.generateClientId) {
    setCookie('_dcid', eventModel.client_id, {
      domain: 'auto',
      path: '/',
      samesite: getCookieType(eventModel),
      secure: true,
      'max-age': 63072000, // 2 years
      httpOnly: false,
    });
  }
}

function getObjectLength(object) {
  let length = 0;

  for (let key in object) {
    if (object.hasOwnProperty(key)) {
      ++length;
    }
  }
  return length;
}

function setResponseHeaders(statusCode) {
  setResponseHeader('Access-Control-Max-Age', '600');
  setResponseHeader('Access-Control-Allow-Origin', getRequestHeader('origin'));
  setResponseHeader(
    'Access-Control-Allow-Methods',
    'GET,POST,PUT,DELETE,OPTIONS'
  );
  setResponseHeader(
    'Access-Control-Allow-Headers',
    'content-type,set-cookie,x-robots-tag,x-gtm-server-preview,x-onetagger-preview'
  );
  setResponseHeader('Access-Control-Allow-Credentials', 'true');
  setResponseStatus(statusCode);
}

function getCookieType(eventModel) {
  if (!eventModel.page_location) {
    return 'Lax';
  }

  const host = getRequestHeader('host');
  const effectiveTldPlusOne = computeEffectiveTldPlusOne(
    eventModel.page_location
  );

  if (!host || !effectiveTldPlusOne) {
    return 'Lax';
  }

  if (host && host.indexOf(effectiveTldPlusOne) !== -1) {
    return 'Lax';
  }

  return 'None';
}

function prepareResponseBody(eventModels) {
  if (data.responseBody === 'empty') {
    return;
  }

  const responseModel = isEventModelsWrappedInArray
    ? eventModels[0]
    : eventModels;

  setResponseHeader('Content-Type', 'application/json');

  if (data.responseBody === 'eventData') {
    setResponseBody(JSON.stringify(responseModel));

    return;
  }

  if (isEventModelsWrappedInArray) {
    setResponseBody(
      JSON.stringify({
        timestamp: responseModel.timestamp,
        unique_event_id: responseModel.unique_event_id,
      })
    );
    return;
  }

  setResponseBody(
    JSON.stringify(
      eventModels.map((eventModel) => {
        return {
          timestamp: eventModel.timestamp,
          unique_event_id: eventModel.unique_event_id,
        };
      })
    )
  );
}

function getEcommerceAction(eventModel) {
  if (eventModel.ecommerce) {
    const actions = [
      'detail',
      'click',
      'add',
      'remove',
      'checkout',
      'checkout_option',
      'purchase',
      'refund',
    ];

    for (let index = 0; index < actions.length; ++index) {
      const action = actions[index];

      if (eventModel.ecommerce[action]) {
        return action;
      }
    }
  }

  return null;
}

function setRedirectLocation() {
  let location = data.redirectTo;

  if (data.lookupForRedirectToParam && data.redirectToQueryParamName) {
    const param = getRequestQueryParameter(data.redirectToQueryParamName);
    if (param && param.startsWith('http')) {
      location = param;
    }
  }
  setResponseHeaders('location', location);
}

function setClientErrorResponseMessage() {
  if (data.clientErrorResponseMessage) {
    setResponseBody(data.clientErrorResponseMessage);
  }
}

function getEventModels(baseEventModel) {
  const body = getRequestBody();

  if (body) {
    const contentType = getRequestHeader('content-type');
    const isFormUrlEncoded =
      !!contentType &&
      contentType.indexOf('application/x-www-form-urlencoded') !== -1;
    let bodyJson = isFormUrlEncoded ? parseUrlEncoded(body) : JSON.parse(body);
    if (bodyJson) {
      const bodyType = getType(bodyJson);
      const shouldUseOriginalBody =
        data.acceptMultipleEvents && bodyType === 'array';
      if (!shouldUseOriginalBody) {
        bodyJson = [bodyJson];
        isEventModelsWrappedInArray = true;
      }

      return bodyJson.map((bodyItem) => {
        const eventModel = assign({}, baseEventModel, {
          timestamp: makeInteger(getTimestampMillis() / 1000),
          unique_event_id:
            getTimestampMillis() + '_' + generateRandom(100000000, 999999999),
        });
        for (let bodyItemKey in bodyItem) {
          eventModel[bodyItemKey] = bodyItem[bodyItemKey];
        }
        return eventModel;
      });
    }
  }

  return [
    assign({}, baseEventModel, {
      timestamp: makeInteger(getTimestampMillis() / 1000),
      unique_event_id:
        getTimestampMillis() + '_' + generateRandom(100000000, 999999999),
    }),
  ];
}

function getClientId(eventModels) {
  for (let i = 0; i < eventModels.length; i++) {
    const eventModel = eventModels[i];
    const clientId =
      eventModel.client_id || eventModel.data_client_id || eventModel._dcid;
    if (clientId) return clientId;
  }

  const dcid = getCookieValues('_dcid');
  if (dcid && dcid[0]) return dcid[0];

  if (data.generateClientId) {
    return (
      'dcid.1.' +
      getTimestampMillis() +
      '.' +
      generateRandom(100000000, 999999999)
    );
  }
  return '';
}

function assign() {
  const target = arguments[0];
  for (let i = 1; i < arguments.length; i++) {
    for (let key in arguments[i]) {
      target[key] = arguments[i][key];
    }
  }
  return target;
}

function parseUrlEncoded(data) {
  const pairs = data.split('&');
  const parsedData = {};
  const regex = createRegex('\\+', 'g');
  for (const pair of pairs) {
    const pairValue = pair.split('=');
    const key = pairValue[0];
    const value = pairValue[1];
    const keys = key
      .split('.')
      .map((k) => decodeUriComponent(k.replace(regex, ' ')));

    let currentObject = parsedData;

    for (let i = 0; i < keys.length - 1; i++) {
      const currentKey = keys[i];

      if (!currentObject[currentKey]) {
        const nextKey = keys[i + 1];
        const nextKeyIsNumber = makeString(makeInteger(nextKey)) === nextKey;
        currentObject[currentKey] = nextKeyIsNumber ? [] : {};
      }

      currentObject = currentObject[currentKey];
    }

    const lastKey = keys[keys.length - 1];
    const decodedValue = decodeUriComponent(value.replace(regex, ' '));
    const parsedValue = JSON.parse(decodedValue) || decodedValue;

    if (getType(currentObject) === 'array') {
      currentObject.push(parsedValue);
    } else {
      currentObject[lastKey] = parsedValue;
    }
  }

  return parsedData;
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "return_response",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_response",
        "versionId": "1"
      },
      "param": [
        {
          "key": "writeResponseAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "writeHeaderAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "run_container",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "onetagger"
              },
              {
                "type": 1,
                "string": "_dcid"
              },
              {
                "type": 1,
                "string": "FPIDP"
              },
              {
                "type": 1,
                "string": "FPID"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "onetagger"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_dcid"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "FPIDP"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Quick Test
  code: runCode();
setup: ''


___NOTES___

Created on 3/12/2024, 11:55:30


